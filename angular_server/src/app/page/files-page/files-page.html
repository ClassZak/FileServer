<app-app-header></app-app-header>
<main class="MainContent">
	@if (isLoading){
		<app-loading-spinner [title]="'–ó–∞–≥—Ä—É–∑–∫–∞'">
		</app-loading-spinner>
	} @else {
	<div class="files-page-container">
		<!-- SEARCH MODE -->
		@if (isSearchMode) {
			<div class="search-mode-panel">
				<div class="flex">
					<div class="search-mode-info">
						<span class="search-mode-label">–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞:</span>
						<span class="search-mode-query">
							"{{ searchQuery }}" –≤ {{ searchPath || '–∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ' }}
						</span>
					</div>
					<app-redirection-button
						[reference]="'/files/' + currentPath"
						title="–í—ã–π—Ç–∏ –∏–∑ –ø–æ–∏—Å–∫–∞"
						className="search-mode-exit-button"
					></app-redirection-button>
				</div>
			</div>

			<div class="search-results">
				@if (searchLoading) {
					<div class="search-loading">
						<div class="loading-spinner"></div>
						<p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫...</p>
					</div>
				} @else if (error) {
					<app-error-message
						[message]="error"
						(onClose)="error = ''"
						[showNavigation]="true"
						(onNavigateUp)="navigateUp()"
						[showUpButton]="!!searchPath"
					></app-error-message>
				} @else if (searchResults) {
					<div class="search-results-header">
						<h2 class="search-results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
						<div class="search-results-stats">
							<p>–ü–æ –∑–∞–ø—Ä–æ—Å—É <span class="highlight">"{{ searchQuery }}"</span></p>
							<p>–í –ø–∞–ø–∫–µ: <span class="highlight">{{ searchPath || '–∫–æ—Ä–Ω–µ–≤–∞—è' }}</span></p>
							<p>–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: <span class="highlight">{{ searchResults.totalResults }}</span></p>
						</div>
					</div>

					@if (searchResults.totalResults > 0) {
						@if (searchResults.folders.length) {
							<app-found-folders-table
								[folders]="searchResults.folders"
								(prepareDelete)="prepareDelete($event.path, $event.name)"
							></app-found-folders-table>
						}
						@if (searchResults.files.length) {
							<app-found-files-table
								[files]="searchResults.files"
								(onDownload)="handleDownload($event.path, $event.name)"
								(onDelete)="prepareDelete($event.path, $event.name)"
								[searchPath]="searchPath"
							></app-found-files-table>
						}
					} @else {
						<div class="no-results">
							<div class="no-results-icon">üîç</div>
							<h3 class="no-results-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
							<p class="no-results-description">
								–ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ searchQuery }}" –≤ –ø–∞–ø–∫–µ "{{ searchPath || '–∫–æ—Ä–Ω–µ–≤–∞—è' }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
							</p>
							<div class="no-results-actions">
								<app-redirection-button
									[reference]="'/files/' + currentPath"
									title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É —Ñ–∞–π–ª–æ–≤"
									className="return-button"
								></app-redirection-button>
							</div>
						</div>
					}
				}
			</div>
		} @else {
			<!-- NORMAL NAVIGATION MODE -->
			<div class="files-header">
				<h1 class="files-title">–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h1>
			</div>

			<div class="navigation-panel">
				<app-file-search [currentPath]="currentPath"></app-file-search>
				<app-breadcrumbs
					[currentPath]="currentPath"
					(navigate)="navigateToFolder($event)"
					(navigateUp)="navigateUp()"
				></app-breadcrumbs>
				<div class="navigation-row">
					<div class="path-input-container">
						<form (ngSubmit)="onPathSubmit()" class="path-form">
							<input
								type="text"
								name="pathInput"
								[(ngModel)]="pathInput"
								(ngModelChange)="onPathInputChange($event)"
								placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: documents/images)"
								class="path-input"
							/>
							<button type="submit" class="path-submit-button">–ü–µ—Ä–µ–π—Ç–∏</button>
						</form>
					</div>

					<div class="navigation-actions">
						<button
							(click)="navigateUp()"
							[disabled]="!currentPath"
							class="nav-button back-button"
							type="button"
						>
							–ù–∞–∑–∞–¥
						</button>
					</div>
				</div>

				<span class="current-path-label">–¢–µ–∫—É—â–∏–π –ø—É—Ç—å:</span> {{ currentPath || '/' }}

				<div style="display: flex; gap: 10px; margin-top: 10px;">
					<button
						(click)="openCreateFolderModal()"
						class="nav-button create-button"
						type="button"
					>
						–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É
					</button>

					<label class="nav-button upload-button">
						{{ uploading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª' }}
						<input
							type="file"
							class="file-input"
							(change)="handleFileUpload($event)"
							[disabled]="uploading"
						/>
					</label>
				</div>
			</div>

			<!-- Error message -->
			<app-error-message
				[message]="error"
				(onClose)="error = ''"
				[showNavigation]="true"
				(onNavigateUp)="navigateUp()"
				[showUpButton]="!!currentPath"
			></app-error-message>

			<!-- Loading indicator -->
			@if (isLoading) {
				<div class="loading-container">
					<div class="loading-spinner"></div>
					<p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</p>
				</div>
			}

			<!-- File and folder tables -->
			@if (!isLoading) {
				<app-folder-table
					[folders]="folders"
					(prepareDelete)="prepareDelete($event.path, $event.name)"
				></app-folder-table>
				<app-file-table
					[files]="files"
					(onDownload)="handleDownload($event.path, $event.name)"
					(onDelete)="prepareDelete($event.path, $event.name)"
				></app-file-table>
			}
		}
	</div>
	@if (isAdmin){
		<!--div class="buttons-row">
			<app-redirection-button 
				[className]="'blue-button'" 
				[title]="'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏'" 
				[reference]="'/users'"
			>
			</app-redirection-button>
			<app-redirection-button 
				[className]="'blue-button'" 
				[title]="'–ì—Ä—É–ø–ø—ã'" 
				[reference]="'/groups'"
			>
			</app-redirection-button>
		</div-->
	}
	}
</main>
<app-footer></app-footer>

<!-- Modals -->
<app-create-folder-modal
	[isOpen]="showCreateFolderModal"
	(onClose)="closeCreateFolderModal()"
	[currentPath]="currentPath"
	(onConfirm)="handleCreateFolder($event)"
></app-create-folder-modal>

<app-delete-confirmation-modal
	[isOpen]="showDeleteModal"
	(onClose)="closeDeleteModal()"
	[itemName]="itemToDelete?.name || ''"
	(onConfirm)="handleDelete()"
></app-delete-confirmation-modal>